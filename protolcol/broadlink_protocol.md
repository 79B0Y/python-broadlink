# Broadlink设备发现协议规格

## 协议概述

Broadlink设备发现使用UDP协议，通过广播或单播方式在局域网内发现设备。

- **传输协议**: UDP
- **默认端口**: 80
- **数据包类型**: Hello Request/Response
- **字节序**: 小端序（Little Endian）

## Hello请求包结构

### 数据包总长度
- **固定长度**: 48字节 (0x30)

### 字段布局

| 偏移量 | 长度 | 字段名 | 描述 | 数据类型 |
|--------|------|--------|------|----------|
| 0x00-0x07 | 8B | 保留字段 | 固定为0 | bytes |
| 0x08-0x13 | 12B | 协议时间戳 | 编码的日期时间信息 | datetime_protocol |
| 0x14-0x17 | 4B | 保留字段 | 固定为0 | bytes |
| 0x18-0x1B | 4B | 本机IP | 发送方IP地址（字节序反转） | ipv4_reversed |
| 0x1C-0x1D | 2B | 本机端口 | 发送方UDP端口 | uint16_le |
| 0x1E-0x1F | 2B | 保留字段 | 固定为0 | bytes |
| 0x20-0x21 | 2B | 校验和 | 数据包校验和 | uint16_le |
| 0x22-0x25 | 4B | 保留字段 | 固定为0 | bytes |
| 0x26 | 1B | 命令标志 | 发现命令=6 | uint8 |
| 0x27-0x2F | 9B | 保留字段 | 固定为0 | bytes |

## 协议时间戳编码 (12字节)

| 偏移量 | 长度 | 字段 | 描述 | 范围 |
|--------|------|------|------|------|
| 0x00-0x03 | 4B | 时区偏移 | UTC偏移小时数（有符号） | -12 ~ +12 |
| 0x04-0x05 | 2B | 年份 | 完整年份 | 1900-9999 |
| 0x06 | 1B | 分钟 | 分钟数 | 0-59 |
| 0x07 | 1B | 小时 | 24小时制 | 0-23 |
| 0x08 | 1B | 年份后两位 | YY格式 | 00-99 |
| 0x09 | 1B | 星期 | ISO星期（1=周一...7=周日） | 1-7 |
| 0x0A | 1B | 日 | 月份中的日 | 1-31 |
| 0x0B | 1B | 月 | 月份 | 1-12 |

## 校验和算法

```
checksum = (sum(packet_bytes) + 0xBEAF) & 0xFFFF
```

1. 将数据包所有字节求和（校验和字段设为0x0000）
2. 加上魔术数 `0xBEAF`
3. 取结果的低16位
4. 以小端序写入校验和字段

## IP地址编码

发送方IP地址需要特殊处理：
1. 使用 `socket.inet_aton()` 转换为4字节网络序
2. 将4字节整体反转 `[::-1]`
3. 写入数据包

**示例**:
- 原始IP: `192.168.1.100`
- inet_aton: `[0xC0, 0xA8, 0x01, 0x64]`
- 反转后: `[0x64, 0x01, 0xA8, 0xC0]`

## Hello响应包结构

### 数据包长度
- **最小长度**: 128字节 (0x80)

### 关键字段

| 偏移量 | 长度 | 字段名 | 描述 | 数据类型 |
|--------|------|--------|------|----------|
| 0x34-0x35 | 2B | 产品ID | 设备型号标识 | uint16_le |
| 0x3A-0x3F | 6B | MAC地址 | 设备MAC（需反转） | mac_reversed |
| 0x40-... | 变长 | 设备名称 | UTF-8编码，null结尾 | cstring |
| 0x7F | 1B | 锁定状态 | 0=未锁定, 1=已锁定 | bool |

### MAC地址解码
1. 从0x3A读取6字节
2. 整体反转 `[::-1]`
3. 格式化为 `XX:XX:XX:XX:XX:XX`

## 发现流程

### 客户端（发现方）
1. 创建UDP Socket，绑定本机IP和随机端口
2. 启用SO_BROADCAST选项
3. 构造Hello请求包
4. 发送到目标地址（广播或单播）
5. 接收并解析响应包
6. 定期重发（建议1秒间隔）

### 服务端（设备）
1. 监听UDP 80端口
2. 接收Hello请求
3. 验证校验和和协议格式
4. 构造响应包（包含设备信息）
5. 发送响应到请求方

## 常见设备类型ID

根据协议，产品ID用于标识不同的Broadlink设备型号：

```
0x2711: RM系列（红外遥控器）
0x2712: RM2系列
0x2787: RM Mini3
0x27A7: RM Pro Plus
... （具体型号需要查阅官方文档）
```

## 网络配置

### 广播发现
- 目标地址: `255.255.255.255:80` 或子网广播地址
- 适用于发现所有设备

### 单播发现
- 目标地址: `设备IP:80`
- 适用于已知设备IP的场景

### 多网卡处理
- 可指定本机IP选择发送网卡
- 未指定时使用 `0.0.0.0` 让系统选择

## 安全考虑

1. **无认证**: 发现协议不包含认证机制
2. **明文传输**: 所有信息明文传输
3. **网络隔离**: 建议在可信网络环境中使用
4. **防火墙**: 需要开放UDP 80端口

## 实现注意事项

1. **字节序**: 严格按照小端序处理多字节字段
2. **超时处理**: 实现合理的超时和重试机制
3. **去重**: 基于(IP, MAC, DevType)进行去重
4. **错误处理**: 处理网络异常和协议解析错误
5. **编码**: 设备名称使用UTF-8编码